{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="record">
  <div class="reserve-action card-container">
    <h1 class="gradient-text">å®Œäº†</h1>
    <p>ä»Šæ—¥ã®è¨˜éŒ²ã‚’æ®‹ã—ã¾ã—ã‚‡ã†</p>

    <form id="recordForm" method="post" class="custom-form">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ form.activity_type.id_for_label }}">ç¨®åˆ¥ï¼ˆå¿…é ˆï¼‰</label>
        {{ form.activity_type }}
        {% for e in form.activity_type.errors %}<p class="error">{{ e }}</p>{% endfor %}
      </div>

      <div class="form-group">
        <label for="{{ form.memo.id_for_label }}">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        {{ form.memo }}
        {% for e in form.memo.errors %}<p class="error">{{ e }}</p>{% endfor %}
      </div>

      <div class="form-check">
        <label for="{{ form.share_detail.id_for_label }}">
          {{ form.share_detail }}
          <span>è©³ç´°ã‚’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«æŠ•ç¨¿ã™ã‚‹</span>
        </label>
      </div>

      <button type="button" id="openFinishModal" class="reserve-btn full-width">å®Œäº†ã™ã‚‹</button>
    </form>
  </div>
</div>

<div id="finishModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h2 class="gradient-text modal-title">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>

    <div class="modal-icon-wrapper">
      <div class="play-icon-circle">
        <span style="font-size: 40px;">ğŸ‰</span>
      </div>
    </div>

    <div class="modal-message">
      <p class="main-msg">ãƒŠã‚¤ã‚¹ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆï¼</p>
      <p class="sub-msg">ä»Šæ—¥ã®åŠªåŠ›ã‚’ä¿å­˜ã—ã¦çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ</p>
    </div>

    <div class="modal-actions">
      <button id="submitFormBtn" class="reserve-btn full-width">ä¿å­˜ã—ã¦çµ‚äº†</button>
      <button type="button" id="closeFinishModal" class="btn-link">å…¥åŠ›ã‚’ç›´ã™</button>
    </div>
  </div>
</div>

<script>
  window.addEventListener('DOMContentLoaded', () => {
    // 1. é‹å‹•æ™‚é–“ã®è‡ªå‹•å…¥åŠ›
    const urlParams = new URLSearchParams(window.location.search);
    const timeSpent = urlParams.get('time');
    const memoField = document.querySelector('textarea[name="memo"]');
    if (timeSpent && memoField) {
      memoField.value = `é‹å‹•æ™‚é–“ï¼š${timeSpent}\n` + (memoField.value || "");
    }

    // 2. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡
    const finishModal = document.getElementById('finishModal');
    const openBtn = document.getElementById('openFinishModal');
    const closeBtn = document.getElementById('closeFinishModal');
    const submitBtn = document.getElementById('submitFormBtn');
    const recordForm = document.getElementById('recordForm');

    // ã€Œå®Œäº†ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
    openBtn.addEventListener('click', () => {
      finishModal.style.display = 'flex';
    });

    // ã€Œå…¥åŠ›ã‚’ç›´ã™ã€ãƒœã‚¿ãƒ³ã§é–‰ã˜ã‚‹
    closeBtn.addEventListener('click', () => {
      finishModal.style.display = 'none';
    });

    // ã€Œä¿å­˜ã—ã¦çµ‚äº†ã€ã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
    submitBtn.addEventListener('click', () => {
      recordForm.submit();
    });

    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.addEventListener('click', (e) => {
      if (e.target === finishModal) finishModal.style.display = 'none';
    });
  });
</script>
{% endblock %}