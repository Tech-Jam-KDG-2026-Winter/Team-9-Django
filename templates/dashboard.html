{% extends 'base.html' %}
{% block content %}
<div class="dashboard">
  <h2>ãƒ›ãƒ¼ãƒ </h2>
  <h1 class="gradient-text">äºˆç´„ä¸€è¦§</h1>

  <div class="reservation-list">
    {% for item in reservation_items %}
    <div class="reservation-card {% if not item.is_today %}future-card{% endif %}">
      <div class="res-info">
        <span class="res-label">
          {% if item.is_today %}TODAY{% else %}FUTURE{% endif %}
        </span>
        <div class="res-time">{{ item.reservation.start_at|date:"H:i" }}</div>
        <div class="res-date">{{ item.reservation.start_at|date:"næœˆjæ—¥" }}</div>
      </div>

      <div class="res-action-area">
        {% if item.reservation.status == "completed" %}
        <div class="status-badge-complete">é”æˆ ğŸ‰</div>
        {% elif item.can_checkin %}
        <div class="checkin-container">
          <button type="button" class="open-modal-btn start-chip"
            data-url="{% url 'reservation_checkin' item.reservation.id %}">
            é–‹å§‹ã™ã‚‹
          </button>
        </div>
        {% elif item.missed %}
        {% if item.recovery_available %}
        <button type="button" class="open-recovery-modal-btn status-badge-missed" style="cursor: pointer;"
          data-url="{% url 'reservation_recovery' item.reservation.id %}">
          ãƒªã‚«ãƒãƒªãƒ¼
        </button>
        {% else %}
        <span class="status-badge-missed">æœªé”æˆ</span>
        {% endif %}
        {% elif item.recovery %}
        <span class="status-badge-recovery">ãƒªã‚«ãƒãƒªãƒ¼æ¸ˆ</span>
        {% else %}
        <span class="status-badge-pending">å¾…æ©Ÿä¸­</span>
        {% endif %}
      </div>
    </div>
    {% empty %}
    <p class="empty-msg">ä»Šæ—¥ã®äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    {% endfor %}
  </div>
</div>

<div id="globalCheckinModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-x" id="closeModalX">&times;</span>
    <h2 class="gradient-text">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h2>
    <div class="modal-icon-wrapper">
      <div class="play-icon-circle"><span class="play-triangle"></span></div>
    </div>
    <p>æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ<br><small>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦é‹å‹•ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</small></p>

    <form id="globalCheckinForm" method="post" action="">
      {% csrf_token %}
      <div class="modal-actions">
        <button type="submit" class="reserve-btn full-width">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã™ã‚‹</button>
        <button type="button" class="btn-link" id="closeModalBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>
</div>

<div id="globalRecoveryModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-x" id="closeRecoveryModalX">&times;</span>
    <h2 class="gradient-text">ãƒªã‚«ãƒãƒªãƒ¼å®Ÿè¡Œ</h2>
    <div class="modal-icon-wrapper">
      <div class="play-icon-circle" style="background: var(--gold-gradient);">
        <span style="font-size:40px">ğŸ›¡ï¸</span>
      </div>
    </div>
    <p>ãƒªã‚«ãƒãƒªãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ<br><small>â€»ãƒªã‚«ãƒãƒªãƒ¼ã¯é€±ã«1å›ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚</small></p>

    <form id="globalRecoveryForm" method="post" action="">
      {% csrf_token %}
      <div class="modal-actions">
        <button type="submit" class="reserve-btn full-width">ãƒªã‚«ãƒãƒªãƒ¼ã‚’é©ç”¨ã™ã‚‹</button>
        <button type="button" class="btn-link" id="closeRecoveryModalBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('globalCheckinModal');
    const form = document.getElementById('globalCheckinForm');
    const openButtons = document.querySelectorAll('.open-modal-btn');
    const closeElements = [document.getElementById('closeModalX'), document.getElementById('closeModalBtn')];

    // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚
    openButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const actionUrl = btn.getAttribute('data-url');
        form.setAttribute('action', actionUrl); // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å…ˆã‚’ã‚»ãƒƒãƒˆ
        modal.style.display = 'flex'; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      });
    });

    // é–‰ã˜ã‚‹å‡¦ç†
    closeElements.forEach(el => {
      el.addEventListener('click', () => {
        modal.style.display = 'none';
      });
    });

    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.addEventListener('click', (e) => {
      if (e.target === modal) modal.style.display = 'none';
    });
  });
</script>
{% endblock %}